#!/usr/bin/env -S python -u

from pathlib import Path
import subprocess as sp
import sys

from yt_dlp import YoutubeDL
from yt_dlp.postprocessor.common import PostProcessor

RATIO = 1.4
DEFAULT_OUTPUT = str(Path.home() / "Music/Podcasts/%(uploader)s/%(title)s.%(ext)s")


class AtempoPP(PostProcessor):
    def run(self, information):
        input_file = Path(information["filepath"])
        output_file = input_file.with_suffix(f".x{RATIO}" + input_file.suffix)
        cmd = [
            "ffmpeg",
            "-y",
            "-i",
            str(input_file),
            "-filter:a",
            f"atempo={RATIO}",
            str(output_file),
        ]
        sp.run(cmd, check=True)
        return [], information


if __name__ == "__main__":
    params = {
        "format": "ba",
        "outtmpl": DEFAULT_OUTPUT,
    }
    args = sys.argv[1:]
    if len(args) == 0:
        print(f"usage: {sys.argv[0]} URL...")
        sys.exit(1)
    with YoutubeDL(params) as ytdl:
        ytdl.add_post_processor(AtempoPP())
        ytdl.download(args)
