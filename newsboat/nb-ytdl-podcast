#!/usr/bin/env -S python -u

from pathlib import Path
import subprocess as sp
import os
import re
import sys

from yt_dlp import YoutubeDL
from yt_dlp.postprocessor.common import PostProcessor

DEFAULT_RATIO = 1.4
DEFAULT_OUTPUT = str(Path.home() / "Music/Podcasts/%(uploader)s/%(title)s.%(ext)s")
DEFAULT_PLAYLIST_OUTPUT = str(
    Path.home()
    / "Music/Podcasts/%(uploader)s/%(playlist_title)s/%(playlist_index)d %(title)s.%(ext)s"
)


class AtempoPP(PostProcessor):
    def __init__(self, ratio: float, downloader=None):
        super().__init__(downloader)
        self.__ratio = ratio

    def run(self, information):
        input_file = Path(information["filepath"])
        r = str(self.__ratio).rstrip("0").rstrip(".")
        output_file = input_file.with_suffix(f".x{r}" + input_file.suffix)
        cmd = [
            "ffmpeg",
            "-hide_banner",
            "-y",
            "-i",
            str(input_file),
            "-filter:a",
            f"atempo={self.__ratio}",
            str(output_file),
        ]
        sp.run(cmd, check=True)
        return [], information


def clean_urls(urls: list[str]) -> list[str]:
    rxl = re.compile(
        r"^((?:https:\/\/)?(?:www\.)?youtube\.com\/watch\?v=[-_0-9a-zA-Z]{11})(?:&.+)?$"
    )
    rxs = re.compile(r"^((?:https\:\/\/)?youtu\.be\/[-_0-9a-zA-Z]{11})(?:\?.+)?$")
    for i in range(len(urls)):
        u = urls[i]
        if (m := rxl.match(u)) and len(m.groups()) == 1:
            (u,) = m.groups()
        elif (m := rxs.match(u)) and len(m.groups()) == 1:
            (u,) = m.groups()
        urls[i] = u
    return urls


if __name__ == "__main__":
    urls = sys.argv[1:]
    if len(urls) == 0:
        print(f"usage: {sys.argv[0]} URL...")
        sys.exit(1)

    try:
        ratio = float(os.environ.get("RATIO", ""))
    except:
        ratio = DEFAULT_RATIO

    if all(
        re.match(
            r"^(?:https:\/\/)?(?:www\.)?youtube.com\/playlist\?list=[-_0-9a-zA-Z]{18,34}",
            u,
        )
        for u in urls
    ):
        DEFAULT_OUTPUT = DEFAULT_PLAYLIST_OUTPUT
    else:
        urls = clean_urls(urls)

    with YoutubeDL(
        params={
            "format": "ba",
            "outtmpl": os.environ.get("OUTPUT", DEFAULT_OUTPUT),
        }
    ) as ytdl:
        if ratio != 1:
            ytdl.add_post_processor(AtempoPP(ratio=ratio))
        ytdl.download(urls)
